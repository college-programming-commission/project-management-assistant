# =============================================================================
# Project Management Assistant - PRODUCTION Docker Compose
# =============================================================================
#
# ВАЖЛИВО: Використовуйте цей файл для production деплою
# Команда: docker-compose -f docker-compose.prod.yml up -d
#
# =============================================================================

services:
    # =========================================================================
    # Application Service (Laravel + PHP-FPM)
    # =========================================================================
    app:
        build:
            context: .
            dockerfile: Dockerfile
            args:
                - NODE_ENV=production
        image: project-management-assistant-app:latest
        container_name: project-management-app
        restart: always
        working_dir: /var/www/html
        env_file:
            - .env
        environment:
            - APP_ENV=production
            - APP_DEBUG=false
        volumes:
            - app-public:/var/www/html/public
            - app-storage:/var/www/html/storage
        networks:
            project-management-network:
                aliases:
                    - app
        depends_on:
            db:
                condition: service_healthy
            redis:
                condition: service_started
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

    # =========================================================================
    # Web Server (Nginx)
    # =========================================================================
    nginx:
        image: nginx:1.27-alpine
        container_name: project-management-nginx
        restart: always
        ports:
            - '${APP_PORT:-8080}:80'
            # Для HTTPS розкоментуйте:
            # - '${APP_PORT_SSL:-443}:443'
        volumes:
            - ./config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
            - app-public:/var/www/html/public:ro
            # Для HTTPS додайте SSL сертифікати:
            # - ./config/ssl:/etc/nginx/ssl:ro
        networks:
            - project-management-network
        depends_on:
            - app
        healthcheck:
            test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost/']
            interval: 30s
            timeout: 10s
            retries: 3
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

    # =========================================================================
    # PostgreSQL Database
    # =========================================================================
    # PRODUCTION: Порт НЕ публікується назовні для безпеки
    # =========================================================================
    db:
        image: postgres:15-alpine
        container_name: project-management-db
        restart: always
        environment:
            POSTGRES_DB: ${DB_DATABASE:-postgres}
            POSTGRES_USER: ${DB_USERNAME:-laravel}
            POSTGRES_PASSWORD: ${DB_PASSWORD}
            POSTGRES_INITDB_ARGS: '-E UTF8 --locale=C'
            PGDATA: /var/lib/postgresql/data/pgdata
        volumes:
            - db-data:/var/lib/postgresql/data
            - ./backups:/backups
        networks:
            - project-management-network
        # PRODUCTION: Порт закритий! Доступ тільки через Docker network
        # ports:
        #     - '5432:5432'  # НЕ публікувати в production!
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U ${DB_USERNAME:-laravel} -d ${DB_DATABASE:-postgres}']
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

    # =========================================================================
    # Redis Cache & Queue
    # =========================================================================
    redis:
        image: redis:7-alpine
        container_name: project-management-redis
        restart: always
        command: >
            redis-server
            --maxmemory 512mb
            --maxmemory-policy allkeys-lru
            --appendonly yes
            --requirepass ${REDIS_PASSWORD}
        volumes:
            - redis-data:/data
        networks:
            - project-management-network
        healthcheck:
            test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
            interval: 10s
            timeout: 5s
            retries: 5
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

    # =========================================================================
    # Laravel Reverb (WebSocket Server)
    # =========================================================================
    reverb:
        image: project-management-assistant-app:latest
        container_name: project-management-reverb
        restart: always
        command: php artisan reverb:start --host=0.0.0.0 --port=8080
        env_file:
            - .env
        environment:
            - APP_ENV=production
            - APP_DEBUG=false
        ports:
            - '${REVERB_EXTERNAL_PORT:-8081}:8080'
        networks:
            - project-management-network
        depends_on:
            - app
            - redis
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:8080/']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

    # =========================================================================
    # MinIO Object Storage (S3-compatible)
    # =========================================================================
    minio:
        image: minio/minio:latest
        container_name: project-management-minio
        restart: always
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
        volumes:
            - minio-data:/data
        ports:
            - '${MINIO_PORT:-9005}:9000'
            - '${MINIO_CONSOLE_PORT:-9006}:9001'
        command: server /data --console-address ":9001"
        networks:
            - project-management-network
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
            interval: 30s
            timeout: 10s
            retries: 3
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

# =============================================================================
# Networks
# =============================================================================
networks:
    project-management-network:
        name: project-management-network
        driver: bridge
        # ОПЦІОНАЛЬНО: Для повної ізоляції розкоментуйте:
        # internal: true

# =============================================================================
# Volumes
# =============================================================================
volumes:
    db-data:
        name: project-management-db-data
        driver: local
    redis-data:
        name: project-management-redis-data
        driver: local
    app-public:
        name: project-management-public
        driver: local
    app-storage:
        name: project-management-storage
        driver: local
    minio-data:
        name: project-management-minio
        driver: local
