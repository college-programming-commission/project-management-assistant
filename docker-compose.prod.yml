services:
    app:
        build:
            context: .
            dockerfile: Dockerfile
            args:
                - NODE_ENV=production
                - INSTALL_DEV=false
                - BUILD_TIMESTAMP=${BUILD_TIMESTAMP:-$(date +%s)}
            labels:
                - 'build.timestamp=${BUILD_TIMESTAMP:-unknown}'
        image: project-management-assistant-app:latest
        container_name: project-management-app
        restart: always
        working_dir: /var/www/html
        env_file:
            - .env
        volumes:
            - app-public-3:/var/www/html/public
            - app-storage:/var/www/html/storage
        networks:
            project-management-network:
                aliases:
                    - app
        depends_on:
            db:
                condition: service_healthy
            redis:
                condition: service_started
        logging:
            driver: json-file
            options:
                max-size: 10m
                max-file: '3'

    nginx:
        image: nginx:1.27-alpine
        container_name: project-management-nginx
        restart: always
        ports:
            - '${APP_PORT:-8080}:80'
        volumes:
            - ./config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
            - app-public-3:/var/www/html/public:ro
        networks:
            - project-management-network
        depends_on:
            - app
        healthcheck:
            test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost/']
            interval: 30s
            timeout: 10s
            retries: 3
        logging:
            driver: json-file
            options:
                max-size: 10m
                max-file: '3'

    db:
        image: postgres:15-alpine
        container_name: project-management-db
        restart: always
        environment:
            POSTGRES_DB: ${DB_DATABASE:-postgres}
            POSTGRES_USER: ${DB_USERNAME:-laravel}
            POSTGRES_PASSWORD: ${DB_PASSWORD}
            POSTGRES_INITDB_ARGS: '-E UTF8 --locale=C'
            PGDATA: /var/lib/postgresql/data/pgdata
        volumes:
            - db-data:/var/lib/postgresql/data
            - ./backups:/backups
        networks:
            - project-management-network
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U ${DB_USERNAME:-laravel} -d ${DB_DATABASE:-postgres}']
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        logging:
            driver: json-file
            options:
                max-size: 10m
                max-file: '3'

    redis:
        image: redis:7-alpine
        container_name: project-management-redis
        restart: always
        command: >
            redis-server
            --maxmemory 512mb
            --maxmemory-policy allkeys-lru
            --appendonly yes
            --requirepass ${REDIS_PASSWORD}
        volumes:
            - redis-data:/data
        networks:
            - project-management-network
        healthcheck:
            test: ['CMD', 'redis-cli', '-a', '${REDIS_PASSWORD}', 'ping']
            interval: 10s
            timeout: 5s
            retries: 5
        logging:
            driver: json-file
            options:
                max-size: 10m
                max-file: '3'

    reverb:
        image: project-management-assistant-app:latest
        container_name: project-management-reverb
        restart: always
        entrypoint: ['php', 'artisan', 'reverb:start', '--host=0.0.0.0', '--port=8080']
        env_file:
            - .env
        ports:
            - '${REVERB_EXTERNAL_PORT:-8081}:8080'
        networks:
            - project-management-network
        depends_on:
            - app
            - redis
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:8080/']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s
        logging:
            driver: json-file
            options:
                max-size: 10m
                max-file: '3'

    minio:
        image: minio/minio:latest
        container_name: project-management-minio
        restart: always
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
        volumes:
            - minio-data:/data
        ports:
            - '${MINIO_API_PORT:-9005}:9000'
            - '${MINIO_CONSOLE_PORT:-9006}:9001'
        command: server /data --console-address ":9001"
        networks:
            - project-management-network
        healthcheck:
            test: ['CMD', 'mc', 'ready', 'local']
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        logging:
            driver: json-file
            options:
                max-size: 10m
                max-file: '3'

networks:
    project-management-network:
        name: project-management-network
        driver: bridge

volumes:
    db-data:
        name: project-management-db-data
    redis-data:
        name: project-management-redis-data
    app-public-3:
        name: project-management-public
    app-storage:
        name: project-management-storage
    minio-data:
        name: project-management-minio
