# =============================================================================
# Project Management Assistant - Docker Compose Configuration
# =============================================================================

services:
    # =========================================================================
    # Application Service (Laravel + PHP-FPM)
    # =========================================================================
    app:
        build:
            context: .
            dockerfile: Dockerfile
            args:
                - INSTALL_DEV=true
                - BUILD_TIMESTAMP=${BUILD_TIMESTAMP:-$(date +%s)}
        image: project-management-assistant-app:latest
        container_name: project-management-app
        restart: unless-stopped
        working_dir: /var/www/html
        env_file:
            - .env
        environment:
            - CONTAINER_ROLE=app
        volumes:
            # Bind mount для розробки - зміни відразу відображаються
            - .:/var/www/html
            # Виключаємо vendor та node_modules з bind mount
            - /var/www/html/vendor
            - /var/www/html/node_modules
        networks:
            - project-management-network
        depends_on:
            db:
                condition: service_healthy
            redis:
                condition: service_started
        # Note: healthcheck disabled due to minimal base image
        # For production, use external monitoring

    # =========================================================================
    # Web Server (Nginx)
    # =========================================================================
    nginx:
        image: nginx:1.27-alpine
        container_name: project-management-nginx
        restart: unless-stopped
        ports:
            - '${APP_PORT:-8080}:80'
        volumes:
            - ./config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
            - ./public:/var/www/html/public:ro
        networks:
            - project-management-network
        depends_on:
            - app
        healthcheck:
            test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost/']
            interval: 30s
            timeout: 10s
            retries: 3

    # =========================================================================
    # PostgreSQL Database
    # =========================================================================
    # ВАЖЛИВО: Для production середовища:
    # 1. Змініть паролі в .env на надійні
    # 2. Не публікуйте порт 5432 назовні (закоментуйте ports)
    # 3. Використовуйте SSL для підключення
    # 4. Налаштуйте регулярні backup
    # =========================================================================
    db:
        image: postgres:15-alpine
        container_name: project-management-db
        restart: unless-stopped
        environment:
            POSTGRES_DB: ${DB_DATABASE:-postgres}
            POSTGRES_USER: ${DB_USERNAME:-laravel}
            POSTGRES_PASSWORD: ${DB_PASSWORD}
            POSTGRES_INITDB_ARGS: '-E UTF8'
            PGDATA: /var/lib/postgresql/data/pgdata
        volumes:
            - db-data:/var/lib/postgresql/data
        networks:
            - project-management-network
        # УВАГА: Цей порт дозволяє підключення до БД ззовні
        # Для development - зручно, для production - небезпечно!
        # Закоментуйте наступні 2 рядки для production
        ports:
            - '${DB_PORT:-5432}:5432'
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U ${DB_USERNAME:-laravel} -d ${DB_DATABASE:-postgres}']
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

    # =========================================================================
    # Redis Cache & Queue
    # =========================================================================
    redis:
        image: redis:7-alpine
        container_name: project-management-redis
        restart: unless-stopped
        command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
        networks:
            - project-management-network
        healthcheck:
            test: ['CMD', 'redis-cli', 'ping']
            interval: 10s
            timeout: 5s
            retries: 5

    # =========================================================================
    # Laravel Reverb (WebSocket Server)
    # =========================================================================
    reverb:
        image: project-management-assistant-app:latest
        container_name: project-management-reverb
        restart: unless-stopped
        command: php artisan reverb:start --host=0.0.0.0 --port=8080
        env_file:
            - .env
        environment:
            - CONTAINER_ROLE=reverb
        ports:
            - '${REVERB_EXTERNAL_PORT:-8081}:8080'
        networks:
            - project-management-network
        depends_on:
            - app
            - redis
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:8080/']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s

    # =========================================================================
    # MinIO Object Storage (S3-compatible)
    # =========================================================================
    minio:
        image: minio/minio:latest
        container_name: project-management-minio
        restart: unless-stopped
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
        volumes:
            - minio-data:/data
        ports:
            - '${MINIO_PORT:-9002}:9000'
            - '${MINIO_CONSOLE_PORT:-9003}:9001'
        command: server /data --console-address ":9001"
        networks:
            - project-management-network
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
            interval: 30s
            timeout: 10s
            retries: 3

# =============================================================================
# Networks
# =============================================================================
networks:
    project-management-network:
        name: project-management-network
        driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
    db-data:
        name: project-management-db-data
        driver: local
    minio-data:
        name: project-management-minio
        driver: local
